# 指数数据下载功能说明

## 概述
本功能为dataDig项目新增了大盘指数日线数据下载功能，包括指数基本信息和指数日线数据的获取与存储。

## 新增文件结构

### 数据模型
- `src/models/daily_price.py` - 新增了 `IndexBasic` 和 `IndexDaily` 两个数据模型

### 数据库表
- `scripts/sql/index_tables.sql` - 指数相关表的建表SQL语句
  - `index_basic` - 指数基本信息表
  - `index_daily` - 指数日线数据表

### 数据源
- `src/datasource/tushare_client.py` - 新增了以下方法：
  - `query_index_basic()` - 获取指数基本信息
  - `query_index_daily()` - 获取指数日线数据

### 数据仓库
- `src/repository/daily_repository.py` - 新增了以下方法：
  - `upsert_index_basic()` - 批量插入/更新指数基本信息
  - `upsert_index_daily()` - 批量插入/更新指数日线数据
  - `get_max_trade_date_index()` - 获取指数数据表中的最大交易日
  - `has_index_daily_data()` - 检查指定交易日是否已有指数数据

### 服务层
- `src/services/index_ingest_service.py` - 指数数据下载服务
  - `ingest_index_basic_all()` - 下载所有指数基本信息
  - `ingest_major_indices_from_to()` - 下载主要指数日线数据（指定时间范围）
  - `ingest_specific_indices_from_to()` - 下载指定指数日线数据
  - `ingest_incremental()` - 增量下载指数数据

### 主程序
- `src/index_app.py` - 指数数据下载主程序

### 运行脚本
- `scripts/shell/run_index_ingest.sh` - 指数数据下载shell脚本

## 主要指数代码
程序默认会下载以下主要大盘指数：
- 000001.SH - 上证指数
- 399001.SZ - 深证成指
- 399006.SZ - 创业板指
- 000300.SH - 沪深300
- 000016.SH - 上证50
- 000905.SH - 中证500
- 000852.SH - 中证1000
- 000688.SH - 科创50

## 使用方法

### 1. 创建数据库表
```bash
# 在MySQL中执行建表SQL
mysql -u root -p stock_db < scripts/sql/index_tables.sql
```

### 2. 运行指数数据下载
```bash
# 使用shell脚本运行
./scripts/shell/run_index_ingest.sh

# 或者直接运行Python程序
cd /Users/nxm/PycharmProjects/dataDig
python -m src.index_app
```

### 3. 数据下载说明
- 首次运行会下载所有指数基本信息
- 自动进行增量下载，基于数据库中的最大交易日
- 如果数据库为空，会从配置文件中的 `start_date` 开始下载
- 每次运行都会检查是否有新的交易日需要下载

## 日志文件
程序运行日志会保存在 `logs/index_ingest.log`

## 配置文件
使用现有的 `configs/config.yaml` 配置文件，无需额外配置。

## 功能特点
1. **详细的中文日志** - 所有关键操作都有中文日志记录
2. **增量下载** - 支持增量更新，避免重复下载
3. **数据去重** - 使用唯一约束防止重复数据
4. **异常处理** - 包含重试机制和异常处理
5. **清晰的目录结构** - 按照项目规范组织代码
6. **NaN值处理** - 自动处理pandas中的NaN值，避免数据库错误
7. **API参数处理** - 严格遵循Tushare文档要求，ts_code为必选参数，逐个指数获取数据

## 重要说明
根据 [Tushare指数日线行情文档](https://tushare.pro/document/2?doc_id=95)，`ts_code`（指数代码）是必选参数。因此程序会：
- 逐个主要指数调用API获取数据
- 为每个交易日分别获取各指数的数据
- 合并所有指数数据后一次性写入数据库
- 对单个指数获取失败进行异常处理，不影响其他指数
